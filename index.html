<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŸ Special GAME ğŸŒŸ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
        }
        .mobile-button {
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .no-zoom {
            /* è®“åœ¨æ‰‹æ©Ÿä¸Šæ“ä½œæ™‚ä¸æœƒå› ç‚ºé»æ“Šæˆ–æ»‘å‹•è€Œç¸®æ”¾é é¢ */
            touch-action: pan-x pan-y;
        }
        /* é‡å°æ»‘å‹•æ‹¼åœ–çš„éæ¸¡æ•ˆæœ */
        .puzzle-piece {
            transition: transform 0.2s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React; // åŠ å…¥ useRef ä»¥ä¾¿ä½¿ç”¨

        const BirthdayGameApp = () => {
            const [currentPoints, setCurrentPoints] = useState(0);
            const [currentPage, setCurrentPage] = useState('home');
            const [history, setHistory] = useState([]); // ç”¨æ–¼å„²å­˜é é¢æ­·å²
            const [completedGames, setCompletedGames] = useState({}); // è¨˜éŒ„å·²å®Œæˆçš„éŠæˆ²

            // éŠæˆ²è³‡æ–™
            const games = [
                { id: 'guess-number', name: 'çŒœæ•¸å­—éŠæˆ²', description: 'æ•¸å­—ç§˜å¯†ï¼Œç­‰ä½ ä¾†çŒœï¼', points: 3, page: 'guess-number' },
                { id: 'memory-card', name: 'è¨˜æ†¶ç¿»ç‰ŒéŠæˆ²', description: 'è€ƒé©—ä½ çš„è¨˜æ†¶åŠ›ï¼', points: 3, page: 'memory-card' },
                { id: 'jigsaw-puzzle', name: 'æ»‘å‹•æ‹¼åœ–éŠæˆ²', description: 'ç¢ç‰‡æ‹¼æ¹Šï¼Œå±•ç¾å¤§åœ–ï¼', points: 5, page: 'jigsaw-puzzle' },
                { id: 'gacha-game', name: 'å¹¸é‹æŠ½å¡éŠæˆ²', description: 'è©¦è©¦æ‰‹æ°£ï¼ŒæŠ½å¤§çï¼', points: 5, page: 'gacha-game' } // é‡æ–°åŠ å…¥æŠ½å¡éŠæˆ²çš„å…¥å£
            ];

            // å°èˆªåˆ°æŒ‡å®šé é¢
            const navigateTo = (page, params = {}) => {
                setHistory(prev => [...prev, currentPage]); // å„²å­˜ç•¶å‰é é¢
                setCurrentPage(page);
                // å¯ä»¥åœ¨é€™è£¡è™•ç†åƒæ•¸ï¼Œå¦‚æœéœ€è¦çš„è©±
            };

            // è¿”å›ä¸Šä¸€é 
            const goBack = () => {
                if (history.length > 0) {
                    const prevPage = history.pop();
                    setCurrentPage(prevPage);
                    setHistory([...history]); // æ›´æ–° history ç‹€æ…‹ä»¥è§¸ç™¼é‡æ–°æ¸²æŸ“
                } else {
                    setCurrentPage('home'); // å¦‚æœæ²’æœ‰æ­·å²ï¼Œå›åˆ°ä¸»é 
                }
            };

            // è™•ç†éŠæˆ²å®Œæˆä¸¦å¢åŠ é»æ•¸
            const handleGameComplete = (gameId, pointsAwarded) => {
                setCurrentPoints(prevPoints => prevPoints + pointsAwarded);
                setCompletedGames(prev => ({ ...prev, [gameId]: true }));
            };

            // é¦–é çµ„ä»¶
            const HomePage = () => (
                <div className="min-h-screen bg-gradient-to-br from-blue-400 to-purple-500 flex flex-col items-center justify-center p-4 text-white">
                    <h1 className="text-5xl font-black mb-6 text-yellow-300 drop-shadow-lg animate-bounce">
                        ğŸŒŸ ç”Ÿæ—¥é©šå–œéŠæˆ² ğŸŒŸ
                    </h1>
                    <p className="text-xl mb-8 text-center px-4 max-w-md">
                        æ­¡è¿é€²å…¥é€™å€‹å……æ»¿é©šå–œçš„éŠæˆ²ä¸–ç•Œï¼å®Œæˆæ¯å€‹æŒ‘æˆ°ï¼Œç´¯ç©ä½ çš„é©šå–œé»æ•¸ï¼
                    </p>
                    <div className="w-full max-w-md bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-2xl p-6 shadow-2xl border-4 border-white transform hover:scale-105 transition duration-300 ease-in-out">
                        <h2 className="text-3xl font-bold mb-6 text-center text-yellow-200">ä½ çš„é»æ•¸ï¼š{currentPoints} é»</h2>
                        <div className="space-y-4">
                            {games.map(game => (
                                <button
                                    key={game.id}
                                    onClick={() => navigateTo(game.page)}
                                    disabled={completedGames[game.id]}
                                    className={`w-full text-lg font-bold py-4 px-6 rounded-xl shadow-lg transform transition duration-200 ease-in-out mobile-button
                                        ${completedGames[game.id]
                                            ? 'bg-gray-500 bg-opacity-70 text-gray-200 cursor-not-allowed'
                                            : 'bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600 text-white hover:scale-102'
                                        }`}
                                >
                                    {completedGames[game.id] ? `âœ… ${game.name} (å·²å®Œæˆ)` : `${game.name} - ğŸ ${game.points} é»`}
                                    <p className="text-sm font-normal mt-1 opacity-80">{game.description}</p>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );

            // çŒœæ•¸å­—éŠæˆ²çµ„ä»¶ (é€™è£¡çš„ç¨‹å¼ç¢¼æ˜¯åŸºæ–¼æ‚¨åŸå§‹çš„ç‰ˆæœ¬ï¼Œæ‡‰è©²æ˜¯å¥½çš„)
            const GuessNumberGame = () => {
                const [targetNumber] = useState(Math.floor(Math.random() * 100) + 1);
                const [guess, setGuess] = useState('');
                const [message, setMessage] = useState('çŒœä¸€å€‹ 1 åˆ° 100 çš„æ•¸å­—ï¼');
                const [attempts, setAttempts] = useState(0);
                const [isCorrect, setIsCorrect] = useState(false);
                const inputRef = useRef(null);

                const handleGuess = () => {
                    const numGuess = parseInt(guess);
                    if (isNaN(numGuess) || numGuess < 1 || numGuess > 100) {
                        setMessage('è«‹è¼¸å…¥ 1 åˆ° 100 ä¹‹é–“çš„æœ‰æ•ˆæ•¸å­—ï¼');
                        return;
                    }
                    setAttempts(prev => prev + 1);

                    if (numGuess === targetNumber) {
                        setMessage(`æ­å–œä½ ï¼çŒœå°äº†ï¼ä½ ç”¨äº† ${attempts + 1} æ¬¡ï¼`);
                        setIsCorrect(true);
                        handleGameComplete('guess-number', games.find(g => g.id === 'guess-number').points);
                        // ç§»é™¤ navigateTo('success-number'); è®“ç”¨æˆ¶åœç•™åœ¨æˆåŠŸç•«é¢
                    } else if (numGuess < targetNumber) {
                        setMessage('å¤ªä½äº†ï¼å†é«˜ä¸€é»ï¼');
                    } else {
                        setMessage('å¤ªé«˜äº†ï¼å†ä½ä¸€é»ï¼');
                    }
                    setGuess('');
                    inputRef.current.focus();
                };

                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-400 to-teal-500 flex flex-col items-center justify-center p-4 text-white">
                        <h2 className="text-4xl font-bold mb-6 text-yellow-300 drop-shadow-lg">çŒœæ•¸å­—éŠæˆ²</h2>
                        <div className="w-full max-w-md bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-2xl p-6 shadow-2xl border-4 border-white">
                            <p className="text-xl mb-6 text-center">{message}</p>
                            {!isCorrect && (
                                <div className="flex flex-col items-center space-y-4">
                                    <input
                                        type="number"
                                        value={guess}
                                        onChange={(e) => setGuess(e.target.value)}
                                        onKeyPress={(e) => { if (e.key === 'Enter') handleGuess(); }}
                                        className="w-full p-3 text-2xl text-center text-gray-800 bg-white rounded-lg border-2 border-blue-300 focus:outline-none focus:ring-4 focus:ring-blue-400"
                                        ref={inputRef}
                                        autoFocus
                                    />
                                    <button
                                        onClick={handleGuess}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md mobile-button"
                                    >
                                        çŒœï¼
                                    </button>
                                </div>
                            )}
                            {isCorrect && (
                                <button
                                    onClick={() => navigateTo('success-number')}
                                    className="w-full mt-6 bg-gradient-to-r from-yellow-400 to-orange-400 text-white px-6 py-3 rounded-lg font-bold shadow-md mobile-button"
                                >
                                    æŸ¥çœ‹çå‹µï¼
                                </button>
                            )}
                            <button
                                onClick={goBack}
                                className="w-full mt-6 bg-gradient-to-r from-purple-400 to-pink-400 text-white px-6 py-3 rounded-lg font-bold shadow-md mobile-button"
                            >
                                ğŸ  å›åˆ°ä¸»ç•«é¢
                            </button>
                        </div>
                    </div>
                );
            };

            // è¨˜æ†¶ç¿»ç‰ŒéŠæˆ²çµ„ä»¶ (é€™è£¡çš„ç¨‹å¼ç¢¼æ˜¯åŸºæ–¼æ‚¨åŸå§‹çš„ç‰ˆæœ¬ï¼Œæ‡‰è©²æ˜¯å¥½çš„)
            const MemoryCardGame = () => {
                const initialCards = [
                    'ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¤–', 'ğŸ‘¾',
                    'ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¤–', 'ğŸ‘¾'
                ].sort(() => Math.random() - 0.5);

                const [cards, setCards] = useState(initialCards.map((emoji, index) => ({
                    id: index,
                    emoji,
                    isFlipped: false,
                    isMatched: false
                })));
                const [flippedCards, setFlippedCards] = useState([]);
                const [matches, setMatches] = useState(0);
                const [moves, setMoves] = useState(0);
                const [gameWon, setGameWon] = useState(false);
                const [lockBoard, setLockBoard] = useState(false);

                useEffect(() => {
                    if (flippedCards.length === 2) {
                        setLockBoard(true);
                        const [card1, card2] = flippedCards;
                        if (cards[card1.id].emoji === cards[card2.id].emoji) {
                            setMatches(prev => prev + 1);
                            setCards(prevCards =>
                                prevCards.map(card =>
                                    card.id === card1.id || card.id === card2.id
                                        ? { ...card, isMatched: true }
                                        : card
                                )
                            );
                            setFlippedCards([]);
                            setLockBoard(false);
                        } else {
                            setTimeout(() => {
                                setCards(prevCards =>
                                    prevCards.map(card =>
                                        card.id === card1.id || card.id === card2.id
                                            ? { ...card, isFlipped: false }
                                            : card
                                    )
                                );
                                setFlippedCards([]);
                                setLockBoard(false);
                            }, 1000);
                        }
                    }
                }, [flippedCards, cards]);

                useEffect(() => {
                    if (matches === initialCards.length / 2) {
                        setGameWon(true);
                        handleGameComplete('memory-card', games.find(g => g.id === 'memory-card').points);
                        // ç§»é™¤ navigateTo('success-memory'); è®“ç”¨æˆ¶åœç•™åœ¨æˆåŠŸç•«é¢
                    }
                }, [matches]);

                const handleCardClick = (clickedCard) => {
                    if (lockBoard || clickedCard.isFlipped || clickedCard.isMatched) return;

                    setMoves(prev => prev + 1);
                    setCards(prevCards =>
                        prevCards.map(card =>
                            card.id === clickedCard.id ? { ...card, isFlipped: true } : card
                        )
                    );
                    setFlippedCards(prev => [...prev, clickedCard]);
                };

                const resetGame = () => {
                    const shuffledCards = initialCards.map((emoji, index) => ({
                        id: index,
                        emoji,
                        isFlipped: false,
                        isMatched: false
                    })).sort(() => Math.random() - 0.5);
                    setCards(shuffledCards);
                    setFlippedCards([]);
                    setMatches(0);
                    setMoves(0);
                    setGameWon(false);
                    setLockBoard(false);
                };

                return (
                    <div className="min-h-screen bg-gradient-to-br from-pink-400 to-red-500 flex flex-col items-center justify-center p-4 text-white">
                        <h2 className="text-4xl font-bold mb-6 text-yellow-300 drop-shadow-lg">è¨˜æ†¶ç¿»ç‰ŒéŠæˆ²</h2>
                        <div className="w-full max-w-lg bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-2xl p-6 shadow-2xl border-4 border-white text-center">
                            <p className="text-xl mb-4">æ­¥æ•¸: {moves}</p>
                            {!gameWon && (
                                <div className="grid grid-cols-4 gap-3 mb-6">
                                    {cards.map(card => (
                                        <div
                                            key={card.id}
                                            onClick={() => handleCardClick(card)}
                                            className={`w-full h-24 sm:h-32 bg-gray-700 bg-opacity-60 rounded-lg flex items-center justify-center text-5xl cursor-pointer transform transition duration-300 mobile-button
                                                ${card.isFlipped || card.isMatched ? 'bg-blue-300 text-gray-900' : 'hover:scale-105'}`}
                                            style={{
                                                perspective: '1000px', // ç‚ºäº†ç¿»ç‰Œæ•ˆæœ
                                                transition: 'transform 0.3s'
                                            }}
                                        >
                                            <div className="relative w-full h-full" style={{ transformStyle: 'preserve-3d' }}>
                                                <div
                                                    className={`absolute w-full h-full flex items-center justify-center rounded-lg backface-hidden ${card.isFlipped || card.isMatched ? 'rotateY-0' : 'rotateY-180'}`}
                                                    style={{
                                                        background: 'linear-gradient(to right bottom, #f0e68c, #ffd700)',
                                                        transform: card.isFlipped || card.isMatched ? 'rotateY(0deg)' : 'rotateY(180deg)'
                                                    }}
                                                >
                                                    {card.isFlipped || card.isMatched ? card.emoji : ''}
                                                </div>
                                                <div
                                                    className={`absolute w-full h-full flex items-center justify-center rounded-lg backface-hidden ${card.isFlipped || card.isMatched ? 'rotateY-180' : 'rotateY-0'}`}
                                                    style={{
                                                        background: 'linear-gradient(to right bottom, #87ceeb, #00bfff)',
                                                        transform: card.isFlipped || card.isMatched ? 'rotateY(180deg)' : 'rotateY(0deg)'
                                                    }}
                                                >
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            {gameWon && (
                                <button
                                    onClick={() => navigateTo('success-memory')}
                                    className="w-full mt-6 bg-gradient-to-r from-yellow-400 to-orange-400 text-white px-6 py-3 rounded-lg font-bold shadow-md mobile-button"
                                >
                                    æŸ¥çœ‹çå‹µï¼
                                </button>
                            )}
                            <button
                                onClick={goBack}
                                className="w-full mt-6 bg-gradient-to-r from-purple-400 to-pink-400 text-white px-6 py-3 rounded-lg font-bold shadow-md mobile-button"
                            >
                                ğŸ  å›åˆ°ä¸»ç•«é¢
                            </button>
                        </div>
                    </div>
                );
            };

            // æ»‘å‹•æ‹¼åœ–éŠæˆ²çµ„ä»¶ (é€™è£¡ä¿ç•™äº†æ‚¨ä¹‹å‰æä¾›ä¸”èƒ½é‹è¡Œçš„éƒ¨åˆ†ï¼Œä¸¦åŠ å…¥åœ–ç‰‡è¼‰å…¥åˆ¤æ–·)
            const JigsawPuzzleGame = () => {
                const [pieces, setPieces] = useState([]);
                const [originalImageSize, setOriginalImageSize] = useState({ width: 0, height: 0 });
                const [displayImageSize, setDisplayImageSize] = useState({ width: 0, height: 0 });
                const [selectedPiece, setSelectedPiece] = useState(null); // ç•¶å‰é¸ä¸­çš„æ‹¼åœ–å¡Š
                const [emptySpot, setEmptySpot] = useState(null); // ç©ºç™½æ ¼çš„ä½ç½®
                const [isPuzzleActive, setIsPuzzleActive] = useState(false); // æ‹¼åœ–æ˜¯å¦å¯ä»¥äº’å‹•
                const [isLoading, setIsLoading] = useState(true); // åœ–ç‰‡æ˜¯å¦æ­£åœ¨è¼‰å…¥
                const [message, setMessage] = useState("è¼‰å…¥åœ–ç‰‡ä¸­...");

                const imageUrl = 'https://Avis0930.github.io/my-surprise-game/demo.jpg'; // ç¢ºä¿é€™æ˜¯æ‚¨è¦ç”¨çš„åœ–ç‰‡è·¯å¾‘
                const rows = 3;
                const cols = 3;

                useEffect(() => {
                    setIsLoading(true);
                    setMessage("è¼‰å…¥åœ–ç‰‡ä¸­...");
                    const img = new Image();
                    img.src = imageUrl;

                    img.onload = () => {
                        // æª¢æŸ¥åœ–ç‰‡æ˜¯å¦ç¢ºå¯¦æœ‰å¯¬é«˜
                        if (img.naturalWidth === 0 || img.naturalHeight === 0) {
                            console.error("åœ–ç‰‡è¼‰å…¥å¤±æ•—æˆ–å°ºå¯¸ç‚ºé›¶ã€‚è«‹æª¢æŸ¥åœ–ç‰‡æ–‡ä»¶ã€‚", imageUrl);
                            setMessage("åœ–ç‰‡è¼‰å…¥å¤±æ•—æˆ–å°ºå¯¸ç•°å¸¸ã€‚");
                            setIsLoading(false);
                            return;
                        }

                        // è¨ˆç®—æ‹¼åœ–é¡¯ç¤ºçš„å°ºå¯¸ï¼Œä½¿å…¶é©æ‡‰è¢å¹•å¤§å°
                        const scaleFactor = Math.min(
                            (window.innerWidth * 0.8) / img.naturalWidth,
                            (window.innerHeight * 0.7) / img.naturalHeight
                        );
                        const displayWidth = img.naturalWidth * scaleFactor;
                        const displayHeight = img.naturalHeight * scaleFactor;

                        let initialPieces = [];
                        for (let i = 0; i < rows * cols; i++) {
                            initialPieces.push({
                                id: i,
                                correctPos: i,
                                currentPos: i,
                                // è¨ˆç®—æ¯å€‹æ‹¼åœ–å¡Šåœ¨é¡¯ç¤ºå°ºå¯¸ä¸‹çš„ä½ç½®
                                x: (i % cols) * (displayWidth / cols),
                                y: Math.floor(i / cols) * (displayHeight / rows),
                            });
                        }

                        // ç‚ºæ»‘å‹•æ‹¼åœ–ç§»é™¤æœ€å¾Œä¸€å¡Šä½œç‚ºç©ºç™½æ ¼
                        const lastPieceId = rows * cols - 1;
                        const initialEmptySpot = { ...initialPieces[lastPieceId] }; // è¤‡è£½æœ€å¾Œä¸€å¡Šçš„ä½ç½®
                        setEmptySpot(initialEmptySpot); // è¨­å®šç©ºç™½æ ¼çš„åˆå§‹ä½ç½®

                        // å¾æ‹¼åœ–å¡Šä¸­ç§»é™¤æœ€å¾Œä¸€å¡Š
                        const actualPieces = initialPieces.slice(0, lastPieceId);

                        // éš¨æ©Ÿæ‰“äº‚æ‹¼åœ–
                        const shuffledPieces = shuffleArray(actualPieces);
                        // æ›´æ–°æ‰“äº‚å¾Œæ‹¼åœ–å¡Šçš„ currentPos
                        setPieces(shuffledPieces.map((piece, index) => ({
                            ...piece,
                            currentPos: index < lastPieceId ? shuffledPieces[index].correctPos : lastPieceId // ä¿æŒæ­£ç¢ºçš„ä½ç½®
                        })));
                        
                        setOriginalImageSize({ width: img.naturalWidth, height: img.naturalHeight });
                        setDisplayImageSize({ width: displayWidth, height: displayHeight });
                        setIsLoading(false); // è¼‰å…¥å®Œæˆï¼Œé¡¯ç¤ºæ‹¼åœ–
                        setIsPuzzleActive(true); // å•Ÿå‹•æ‹¼åœ–äº’å‹•
                        setMessage("é»æ“Šæ‹¼åœ–å¡Šé–‹å§‹éŠæˆ²ï¼"); // è¼‰å…¥æˆåŠŸè¨Šæ¯
                    };

                    img.onerror = () => {
                        console.error("åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥åœ–ç‰‡è·¯å¾‘æˆ–æ–‡ä»¶æ˜¯å¦æå£ã€‚", imageUrl);
                        setMessage("åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥åœ–ç‰‡è·¯å¾‘æˆ–æ–‡ä»¶ã€‚");
                        setIsLoading(false);
                    };
                }, [imageUrl, rows, cols]); // ç¢ºä¿åœ¨ imageUrl, rows, cols æ”¹è®Šæ™‚é‡æ–°åŸ·è¡Œ

                // éš¨æ©Ÿæ‰“äº‚é™£åˆ—çš„å·¥å…·å‡½æ•¸
                const shuffleArray = (array) => {
                    const newArray = [...array];
                    for (let i = newArray.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                    }
                    return newArray;
                };

                // åˆ¤æ–·æ‹¼åœ–æ˜¯å¦å®Œæˆ
                const isSolved = () => {
                    if (pieces.length === 0) return false;
                    // å°æ–¼æ»‘å‹•æ‹¼åœ–ï¼Œæª¢æŸ¥é™¤äº†ç©ºç™½æ ¼ä»¥å¤–çš„æ‰€æœ‰æ‹¼åœ–å¡Šæ˜¯å¦éƒ½åœ¨æ­£ç¢ºçš„ä½ç½®
                    return pieces.every(piece => piece.currentPos === piece.id);
                };

                // è™•ç†æ‹¼åœ–å¡Šé»æ“Šäº‹ä»¶
                const handlePieceClick = (clickedPiece) => {
                    if (!isPuzzleActive) return; // æ‹¼åœ–æœªå•Ÿå‹•ï¼Œä¸éŸ¿æ‡‰é»æ“Š

                    const canMove = (piece, empty) => {
                        const pieceRow = Math.floor(piece.currentPos / cols);
                        const pieceCol = piece.currentPos % cols;
                        const emptyRow = Math.floor(empty.currentPos / cols);
                        const emptyCol = empty.currentPos % cols;

                        // åˆ¤æ–·æ˜¯å¦åœ¨åŒä¸€è¡Œæˆ–åŒä¸€åˆ—ï¼Œä¸”ç›¸é„°
                        const isAdjacentRow = pieceRow === emptyRow && Math.abs(pieceCol - emptyCol) === 1;
                        const isAdjacentCol = pieceCol === emptyCol && Math.abs(pieceRow - emptyRow) === 1;

                        return isAdjacentRow || isAdjacentCol;
                    };

                    if (canMove(clickedPiece, emptySpot)) {
                        setPieces(prevPieces => {
                            const newPieces = prevPieces.map(p =>
                                p.id === clickedPiece.id ? { ...p, currentPos: emptySpot.currentPos } : p
                            );
                            return newPieces;
                        });
                        // ç§»å‹•ç©ºç™½æ ¼åˆ°è¢«é»æ“Šçš„æ‹¼åœ–å¡Šçš„åŸå§‹ä½ç½®
                        setEmptySpot({ ...emptySpot, currentPos: clickedPiece.currentPos });
                    }
                };

                useEffect(() => {
                    if (!isLoading && isSolved()) {
                        setMessage("æ­å–œä½ ï¼æ‹¼åœ–å®Œæˆäº†ï¼");
                        setIsPuzzleActive(false); // åœæ­¢äº’å‹•
                        handleGameComplete('jigsaw-puzzle', games.find(g => g.id === 'jigsaw-puzzle').points);
                        // é€™è£¡å¯ä»¥å°å‘æˆåŠŸé é¢
                        navigateTo('success-puzzle');
                    }
                }, [pieces, isLoading]); // ç›£è½ pieces å’Œ isLoading çš„è®ŠåŒ–

                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-500 to-purple-600 flex flex-col items-center justify-center p-4 text-white no-zoom">
                        <h2 className="text-4xl font-bold mb-6 text-yellow-300 drop-shadow-lg">æ»‘å‹•æ‹¼åœ–éŠæˆ²</h2>
                        <div className="w-full max-w-lg bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-2xl p-6 shadow-2xl border-4 border-white text-center flex flex-col items-center">
                            <p className="text-xl mb-4">{message}</p>
                            {isLoading ? (
                                <div className="text-2xl">è¼‰å…¥ä¸­...</div>
                            ) : (
                                <div
                                    className="relative border-4 border-yellow-300 rounded-lg overflow-hidden shadow-xl"
                                    style={{
                                        width: displayImageSize.width,
                                        height: displayImageSize.height,
                                        aspectRatio: `${displayImageSize.width} / ${displayImageSize.height}`
                                    }}
                                >
                                    {pieces.map(piece => (
                                        <div
                                            key={piece.id}
                                            className={`absolute cursor-pointer puzzle-piece transform ${isPuzzleActive ? 'hover:scale-105' : ''}`}
                                            onClick={() => handlePieceClick(piece)}
                                            style={{
                                                width: displayImageSize.width / cols,
                                                height: displayImageSize.height / rows,
                                                backgroundImage: `url(${imageUrl})`,
                                                backgroundSize: `${displayImageSize.width}px ${displayImageSize.height}px`,
                                                backgroundPosition: `-${piece.x}px -${piece.y}px`,
                                                left: (piece.currentPos % cols) * (displayImageSize.width / cols),
                                                top: Math.floor(piece.currentPos / cols) * (displayImageSize.height / rows),
                                                boxShadow: 'inset 0 0 0 1px rgba(255,255,255,0.3)' // æ‹¼åœ–å¡Šä¹‹é–“çš„é‚Šç•Œ
                                            }}
                                        />
                                    ))}
                                </div>
                            )}
                            <button
                                onClick={goBack}
                                className="w-full mt-6 bg-gradient-to-r from-purple-400 to-pink-400 text-white px-6 py-3 rounded-lg font-bold shadow-md mobile-button"
                            >
                                ğŸ  å›åˆ°ä¸»ç•«é¢
                            </button>
                        </div>
                    </div>
                );
            };

            // æŠ½å¡éŠæˆ²çµ„ä»¶ (é€™è£¡åªæä¾›æ¡†æ¶ï¼Œå¦‚æœåŸå§‹æœ‰å®Œæ•´é‚è¼¯ï¼Œè«‹æ›¿æ›)
            const GachaGame = () => {
                const [result, setResult] = useState(null);
                const [message, setMessage] = useState("é»æ“ŠæŒ‰éˆ•ï¼Œè©¦è©¦ä½ çš„æ‰‹æ°£ï¼");
                const [isSpinning, setIsSpinning] = useState(false);

                const rewards = [
                    { name: 'è¬è¬åƒèˆ‡', type: 'text', weight: 40 },
                    { name: '10é»é©šå–œé»æ•¸', type: 'points', value: 10, weight: 30 },
                    { name: 'ç‰¹åˆ¥ç¦®ç‰© A', type: 'item', weight: 20 },
                    { name: 'ç¥ç§˜å¤§çï¼', type: 'item', weight: 10 }
                ];

                const weightedRandom = (items) => {
                    let i,
                        weights = [];
                    for (i = 0; i < items.length; i++)
                        weights[i] = items[i].weight + (weights[i - 1] || 0);
                    
                    let random = Math.random() * weights[weights.length - 1];
                    for (i = 0; i < weights.length; i++)
                        if (weights[i] > random)
                            break;
                    return items[i];
                };

                const handleSpin = () => {
                    if (isSpinning) return;
                    setIsSpinning(true);
                    setResult(null);
                    setMessage("è½‰å‹•ä¸­...ç¥ä½ å¥½é‹ï¼");

                    setTimeout(() => {
                        const chosenReward = weightedRandom(rewards);
                        setResult(chosenReward);
                        setMessage(`æ­å–œä½ æŠ½åˆ°äº†ï¼š${chosenReward.name}ï¼`);
                        setIsSpinning(false);

                        // åˆ¤æ–·æ˜¯å¦ç‚ºé»æ•¸çå‹µä¸¦å¢åŠ é»æ•¸
                        if (chosenReward.type === 'points') {
                            setCurrentPoints(prevPoints => prevPoints + chosenReward.value);
                        }
                        // å¦‚æœæ˜¯éŠæˆ²å®Œæˆä¸¦çµ¦é»æ•¸ï¼Œå‰‡åƒå…¶ä»–éŠæˆ²ä¸€æ¨£è™•ç†
                        // handleGameComplete('gacha-game', games.find(g => g.id === 'gacha-game').points); // æŠ½å¡é€šå¸¸æ˜¯æ¯æ¬¡éƒ½èƒ½æŠ½ï¼Œè€Œä¸æ˜¯å®ŒæˆéŠæˆ²
                    }, 2000);
                };

                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-blue-700 flex flex-col items-center justify-center p-4 text-white">
                        <h2 className="text-4xl font-bold mb-6 text-yellow-300 drop-shadow-lg">å¹¸é‹æŠ½å¡éŠæˆ²</h2>
                        <div className="w-full max-w-md bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-2xl p-6 shadow-2xl border-4 border-white text-center">
                            <p className="text-xl mb-6">{message}</p>
                            <div className="mb-6 h-24 flex items-center justify-center text-4xl font-bold text-yellow-200">
                                {result ? result.name : (isSpinning ? '...' : 'ç­‰å¾…æŠ½ç')}
                            </div>
                            <button
                                onClick={handleSpin}
                                disabled={isSpinning}
                                className={`w-full py-4 px-6 rounded-xl shadow-lg transform transition duration-300 mobile-button font-bold text-white
                                    ${isSpinning ? 'bg-gray-500 cursor-not-allowed' : 'bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 hover:scale-105'}`}
                            >
                                {isSpinning ? 'è½‰å‹•ä¸­...' : 'ç«‹å³æŠ½å¡ï¼'}
                            </button>
                            <button
                                onClick={goBack}
                                className="w-full mt-6 bg-gradient-to-r from-purple-400 to-pink-400 text-white px-6 py-3 rounded-lg font-bold shadow-md mobile-button"
                            >
                                ğŸ  å›åˆ°ä¸»ç•«é¢
                            </button>
                        </div>
                    </div>
                );
            };


            // æˆåŠŸé é¢çµ„ä»¶
            const SuccessPage = ({ title, emoji, points, gameId }) => (
                <div className="min-h-screen bg-gradient-to-br from-yellow-400 to-orange-500 flex flex-col items-center justify-center p-4 text-white">
                    <h2 className="text-5xl font-black mb-6 animate-pulse">{emoji} {title} {emoji}</h2>
                    <p className="text-2xl mb-8">ä½ ç²å¾—äº† {points} é»é©šå–œé»æ•¸ï¼</p>
                    <div className="flex space-x-4">
                        <button
                            onClick={() => navigateTo('home')}
                            className="bg-green-500 hover:bg-green-600 text-white px-6 py-4 rounded-lg font-bold shadow-lg mobile-button"
                        >
                            ğŸ‰ ç¹¼çºŒæ”¶é›†é»æ•¸
                        </button>
                        {games.some(game => !completedGames[game.id]) && (
                            <button
                                onClick={goBack}
                                className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-4 rounded-lg font-bold shadow-lg mobile-button"
                            >
                                â†©ï¸ è¿”å›éŠæˆ²
                            </button>
                        )}
                    </div>
                </div>
            );

            // æ ¹æ“šç•¶å‰é é¢æ¸²æŸ“
            const renderPage = () => {
                switch (currentPage) {
                    case 'guess-number':
                        return <GuessNumberGame />;
                    case 'memory-card':
                        return <MemoryCardGame />;
                    case 'jigsaw-puzzle':
                        return <JigsawPuzzleGame />;
                    case 'gacha-game': // æŠ½å¡éŠæˆ²é é¢
                        return <GachaGame />;
                    case 'success-number':
                        return <SuccessPage title="æ­å–œéé—œï¼" emoji="ğŸ‰" points={3} gameId="guess-number" />;
                    case 'success-memory':
                        return <SuccessPage title="è¨˜æ†¶é”äººï¼" emoji="ğŸ‰" points={3} gameId="memory-card" />;
                    case 'success-puzzle':
                        // ä¿®æ­£é»æ•¸ç‚º 5ï¼Œèˆ‡ games åˆ—è¡¨ä¿æŒä¸€è‡´
                        return <SuccessPage title="æ‹¼åœ–å¤§å¸«ï¼" emoji="ğŸ§©" points={games.find(g => g.id === 'jigsaw-puzzle').points} gameId="jigsaw-puzzle" />;
                    default:
                        return <HomePage />;
                }
            };

            return renderPage();
        };

        ReactDOM.render(<BirthdayGameApp />, document.getElementById('root'));
    </script>
</body>
</html>
